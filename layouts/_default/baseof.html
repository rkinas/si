<!DOCTYPE html>
<html lang="{{ .Lang }}" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Title }} | {{ .Site.Title }}</title>
    <meta name="description" content="{{ .Description | default .Site.Params.description }}">
    <meta name="author" content="{{ .Site.Params.author }}">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,500;0,600;1,400&family=Source+Code+Pro:wght@400;500&display=swap" rel="stylesheet">

    <!-- Styles -->
    {{ $mainCSS := resources.Get "css/main.css" | minify }}
    <link rel="stylesheet" href="{{ $mainCSS.RelPermalink }}">

    <!-- Theme initialization (prevent flash) -->
    <script>
        (function() {
            const saved = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = saved || (prefersDark ? 'dark' : 'light');
            document.documentElement.dataset.theme = theme;
        })();
    </script>
</head>
<body>
    {{ partial "header.html" . }}

    <main class="content">
        {{ block "main" . }}{{ end }}
    </main>

    {{ partial "footer.html" . }}

    <!-- Scripts -->
    <script>
        // Theme toggle
        document.addEventListener('DOMContentLoaded', function() {
            const toggle = document.querySelector('.theme-toggle');
            if (toggle) {
                toggle.addEventListener('click', function() {
                    const html = document.documentElement;
                    const current = html.dataset.theme;
                    const next = current === 'dark' ? 'light' : 'dark';
                    html.dataset.theme = next;
                    localStorage.setItem('theme', next);
                    updateThemeIcon(next);
                });
            }
            updateThemeIcon(document.documentElement.dataset.theme);
        });

        function updateThemeIcon(theme) {
            const icon = document.querySelector('.theme-icon');
            if (icon) {
                icon.textContent = theme === 'dark' ? '\u2600' : '\u263E';
            }
        }

        // Smooth scroll for ToC links
        document.querySelectorAll('.toc a').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });

        // TOC scroll spy - highlight active section
        function updateTocHighlight() {
            const tocLinks = document.querySelectorAll('.toc a');
            const headings = [];

            tocLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href && href.startsWith('#')) {
                    const heading = document.querySelector(href);
                    if (heading) {
                        headings.push({ element: heading, link: link });
                    }
                }
            });

            if (headings.length === 0) return;

            const scrollPos = window.scrollY + 100;
            let activeLink = null;

            for (let i = headings.length - 1; i >= 0; i--) {
                if (headings[i].element.offsetTop <= scrollPos) {
                    activeLink = headings[i].link;
                    break;
                }
            }

            tocLinks.forEach(link => link.classList.remove('active'));
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        window.addEventListener('scroll', updateTocHighlight);
        window.addEventListener('load', updateTocHighlight);

        // Star rating system
        function initStarRating() {
            const starBtn = document.querySelector('.star-btn');
            const starCount = document.querySelector('.star-count');

            if (!starBtn) return;

            const articleId = starBtn.dataset.article;
            const storageKey = 'starred_articles';
            const countKey = 'star_counts';

            // Get starred articles from localStorage
            function getStarredArticles() {
                const stored = localStorage.getItem(storageKey);
                return stored ? JSON.parse(stored) : [];
            }

            // Get star counts from localStorage
            function getStarCounts() {
                const stored = localStorage.getItem(countKey);
                return stored ? JSON.parse(stored) : {};
            }

            // Check if article is starred
            function isStarred() {
                return getStarredArticles().includes(articleId);
            }

            // Update UI
            function updateUI() {
                const starred = isStarred();
                const counts = getStarCounts();
                const count = counts[articleId] || 0;

                starBtn.classList.toggle('starred', starred);
                starBtn.querySelector('.star-icon').textContent = starred ? '★' : '☆';
                starBtn.querySelector('.star-text').textContent = starred ?
                    (document.documentElement.lang === 'pl' ? 'Polubiono' : 'Starred') :
                    (document.documentElement.lang === 'pl' ? 'Polub' : 'Star');
                starCount.textContent = count;
            }

            // Toggle star
            starBtn.addEventListener('click', function() {
                const articles = getStarredArticles();
                const counts = getStarCounts();

                if (isStarred()) {
                    // Unstar
                    const index = articles.indexOf(articleId);
                    if (index > -1) articles.splice(index, 1);
                    counts[articleId] = Math.max(0, (counts[articleId] || 1) - 1);
                } else {
                    // Star
                    articles.push(articleId);
                    counts[articleId] = (counts[articleId] || 0) + 1;
                }

                localStorage.setItem(storageKey, JSON.stringify(articles));
                localStorage.setItem(countKey, JSON.stringify(counts));
                updateUI();
            });

            updateUI();
        }

        initStarRating();

        // Citation tooltips
        document.querySelectorAll('.cite').forEach(cite => {
            cite.addEventListener('mouseenter', function() {
                const tooltip = this.querySelector('.cite-tooltip');
                if (tooltip) {
                    const rect = this.getBoundingClientRect();
                    if (rect.left < 200) {
                        tooltip.style.left = '0';
                        tooltip.style.transform = 'translateX(0)';
                    } else if (window.innerWidth - rect.right < 200) {
                        tooltip.style.left = 'auto';
                        tooltip.style.right = '0';
                        tooltip.style.transform = 'translateX(0)';
                    }
                }
            });
        });
    </script>
</body>
</html>
